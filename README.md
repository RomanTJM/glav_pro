# CRM Stages — Прототип управления стадиями воронки

Прототип CRM-интерфейса с жёсткими правилами переходов между стадиями.  
Менеджер **не может «перепрыгнуть»** вперёд без выполнения обязательных действий.

---

## Быстрый запуск

### Docker (рекомендуется)

```bash
docker compose up --build -d
```

Приложение: **http://localhost:8080**

Тесты:
```bash
docker compose exec php vendor/bin/phpunit
```

### Без Docker (PHP 8.1+ / SQLite)

```bash
composer install          # или: php composer.phar install
php setup.php             # создаёт SQLite БД с тестовыми данными
php -S localhost:8080 -t public
```

Тесты:
```bash
vendor/bin/phpunit
```

---

## Обоснование выбора формы реализации

Вместо полноценного Joomla-компонента выбрано **standalone PHP-приложение**:

1. **KISS / MVP** — минимум бойлерплейта, фокус на бизнес-логике
2. **Тестируемость** — доменная логика полностью изолирована от фреймворка
3. **Портируемость** — ядро (`src/Domain/`) можно вложить в Joomla-компонент без изменений
4. **Скорость разработки** — нет overhead на Joomla admin/site split, XML-манифесты

> В реальном проекте: обернуть в `com_crmstages` (Joomla 4/5 MVC component), подключить `JFactory::getDbo()` вместо PDO, использовать Joomla ACL для ролей.

---

## Архитектура

```
src/
├── Domain/                       # Чистая бизнес-логика (без зависимостей)
│   ├── Stage.php                 # Enum стадий (C0..A1, N0)
│   ├── EventType.php             # Enum типов событий
│   ├── Event.php                 # Immutable value object события
│   ├── Company.php               # Сущность компании
│   └── StageTransitionRules.php  # ⭐ Все бизнес-правила переходов
├── Service/
│   └── StageService.php          # Оркестрация: проверка → событие → переход
├── Repository/
│   └── CompanyRepository.php     # Работа с БД (PDO, типобезопасные параметры)
├── Config/
│   └── Database.php              # PDO-подключение (SQLite / MySQL)
└── Controller/
    └── CompanyController.php     # HTTP-обработчик с валидацией входных данных

templates/                        # PHP-шаблоны (View)
public/                           # Web-root (index.php, CSS, JS)
tests/Unit/                       # PHPUnit тесты
migrations/                       # SQL-схема для MySQL (Docker)
docker/                           # Docker-конфигурации (Nginx, MySQL)
```

**Принципы:**
- **Domain** не знает о БД, HTTP, фреймворке
- **Service** — тонкий слой оркестрации (проверка правил → запись → переход)
- **Repository** — единственный слой, работающий с PDO; принимает enum'ы (типобезопасность)
- **Controller** — парсинг HTTP, валидация input, вызов сервиса, рендер

---

## Модель данных

### Таблицы

#### `companies`
| Поле       | Тип               | Описание                    |
|------------|--------------------|-----------------------------|
| id         | INT PK AUTO_INC    | ID компании                 |
| name       | VARCHAR(255)       | Название                    |
| stage      | VARCHAR(20)        | Текущая стадия (C0..A1, N0) |
| created_at | DATETIME           | Дата создания               |
| updated_at | DATETIME           | Дата последнего изменения   |

**Индексы:** `idx_stage`, `idx_updated`

#### `company_events` (журнал событий — append-only)
| Поле       | Тип            | Описание                             |
|------------|----------------|--------------------------------------|
| id         | BIGINT PK      | ID события                           |
| company_id | INT FK         | Компания                             |
| event_type | VARCHAR(50)    | Тип события (enum в коде)            |
| event_data | JSON           | Данные (комментарий, дата, сумма...) |
| created_at | DATETIME       | Когда произошло                      |

**Индексы:** `idx_company_id`, `idx_company_type` (композитный), `idx_created`

#### `stage_transitions` (история переходов)
| Поле       | Тип            | Описание       |
|------------|----------------|----------------|
| id         | BIGINT PK      | ID перехода    |
| company_id | INT FK         | Компания       |
| from_stage | VARCHAR(20)    | Откуда         |
| to_stage   | VARCHAR(20)    | Куда           |
| created_at | DATETIME       | Когда перешли  |

**Индексы:** `idx_company_id`, `idx_created`

### Масштабирование до ~10k компаний/день

1. **Индексация** — композитные индексы на `(company_id, event_type)` для быстрой проверки условий переходов
2. **Event sourcing** — `company_events` как append-only журнал; минимум UPDATE → меньше блокировок
3. **Партиционирование** — `company_events` по `created_at` (помесячно) для архивации
4. **Read replicas** — чтение карточки с реплики, запись событий на мастер
5. **Кеширование** — Redis для текущей стадии и списка событий (инвалидация при записи)
6. **Очередь** — тяжёлые побочные эффекты (email, webhook) через RabbitMQ / Redis queue
7. **Оптимистичная блокировка** — `WHERE stage = :expected_stage` при UPDATE для race conditions
8. **CQRS** — разделение read/write: стадию хранить денормализованно, events — в отдельном store

---

## Стадии и правила переходов

| Код | Стадия       | Вход (когда доступно)           | Выход (когда можно дальше)            | Ограничения                      |
|-----|--------------|---------------------------------|---------------------------------------|----------------------------------|
| C0  | Ice          | —                               | Есть попытка контакта                 | —                                |
| C1  | Touched      | Был контакт                     | Есть разговор с ЛПР                  | ❌ Заявка, КП, демо              |
| C2  | Aware        | Есть разговор с ЛПР             | Заполнена форма дискавери             | ❌ Планирование/проведение демо  |
| W1  | Interested   | Дискавери заполнена              | Запланировано демо (дата/время)       | ❌ Заявка, КП                    |
| W2  | DemoPlanned  | Есть дата демо                  | Проведено демо (переход по ссылке)    | ❌ Заявка, КП                    |
| W3  | DemoDone     | Демо проведено < 60 дней        | Есть заявка и/или счёт               | —                                |
| H1  | Committed    | Есть счёт                       | Есть оплата                          | —                                |
| H2  | Customer     | Есть оплата                     | Есть удостоверение                    | —                                |
| A1  | Activated    | Есть удостоверение               | Финальная стадия                     | —                                |

---

## Тестирование

### Что покрыто и почему

| Тест-файл                      | Что тестирует                              | Почему важно                              |
|--------------------------------|-------------------------------------------|-------------------------------------------|
| `StageTest.php`                | Enum стадий: порядок, next(), labels       | Базовая корректность модели стадий        |
| `CompanyTest.php`              | Entity: fromRow, hasEvent, hasRecentEvent  | Корректность работы с событиями           |
| `StageTransitionRulesTest.php` | Все exit-условия + все ограничения         | ⭐ Ядро: менеджер не может перепрыгнуть    |
| `StageServiceTest.php`         | Оркестрация: действие → событие → переход  | Интеграция правил с сервисным слоем       |

### Цикл «баг → исправление → зелёные тесты»

**Баг 1:** `CompanyRepository` был объявлен `final` → PHPUnit не может создать mock через `createMock()`.  
**Исправление:** убрали `final` с класса (Repository — инфраструктура, его мокирование ожидаемо).

**Баг 2:** `StageTest::testNextStageSequence` — PHP enums нельзя использовать как ключи ассоциативного массива.  
**Исправление:** заменили `[Stage => Stage]` на массив пар `[[Stage, Stage], ...]` с деструктуризацией.

**Баг 3:** `CompanyRepository::insertEvent` принимал `string` вместо `EventType` — нарушение типобезопасности.  
**Исправление:** параметр заменён на `EventType $eventType`, обновлены тесты.

---

## AI-workflow

### Какие AI-инструменты использовались

- **Claude (Cursor IDE)** — генерация кода, рефакторинг, тесты, документация, DevOps

### Как строился процесс

1. **Декомпозиция задачи** → подзадачи (Docker, схема БД, домен, сервисы, репозитории, контроллеры, UI, тесты, README)
2. **Domain-first** — сначала enum'ы и правила (чистая логика), потом инфраструктура
3. **Промпты** — подробное ТЗ с acceptance criteria (Given/When/Then)
4. **Итеративная проверка** — после каждого блока: запуск тестов, ревью кода
5. **Рефакторинг** — отдельный проход по всему проекту: типобезопасность, DRY, чистка

### Контроль качества и рисков

- **Галлюцинации** — все бизнес-правила проверены тестами, каждый переход протестирован в обе стороны (can / cannot)
- **Безопасность** — prepared statements (PDO), `htmlspecialchars` в шаблонах, `filter_input` для валидации, `JSON_THROW_ON_ERROR` для JSON
- **Лицензии** — только стандартные зависимости (PHPUnit, PHP stdlib)
- **Ручная проверка** — каждый сгенерированный файл ревьюится перед принятием
- **Цикл тестирования** — нашли 3 бага, все исправлены с объяснением причин

### Где AI дал выигрыш

| Область         | Выигрыш                                              |
|-----------------|-------------------------------------------------------|
| Код             | Быстрая генерация boilerplate (Docker, CSS, шаблоны)  |
| Архитектура     | Clean architecture с Domain/Service/Repository        |
| Тесты           | Генерация тестов с Given/When/Then комментариями      |
| Рефакторинг     | Системный аудит: типобезопасность, DRY, валидация     |
| Документация    | README, комментарии, инструкции менеджеру             |
| DevOps          | Docker-конфигурация, решение проблем совместимости     |

---

## Что бы улучшили

1. **Joomla-обёртка** — упаковка в `com_crmstages` (admin + site views)
2. **Аутентификация/авторизация** — Joomla ACL, разделение ролей менеджер/админ
3. **CSRF-защита** — токены для POST-запросов
4. **Обратные переходы** — возможность «откатить» стадию с записью причины
5. **Уведомления** — email/Telegram при переходе стадии
6. **Дашборд** — визуализация воронки (сколько компаний на каждой стадии)
7. **REST API** — JSON API для интеграции с внешними системами
8. **Audit log** — кто, когда, откуда (IP) совершил действие
9. **Soft delete + архивация** — для компаний и событий старше N месяцев
